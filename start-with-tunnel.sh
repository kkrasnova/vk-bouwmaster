#!/bin/bash

echo "๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ ะธ ััะฝะฝะตะปั ะดะปั ัะดะฐะปะตะฝะฝะพะณะพ ะดะพัััะฟะฐ..."
echo ""

# ะัะพะฒะตััะตะผ, ะทะฐะฟััะตะฝ ะปะธ ัะตัะฒะตั
if ! lsof -ti:3456 > /dev/null 2>&1; then
    echo "๐ฆ ะะฐะฟััะบ HTTPS ัะตัะฒะตัะฐ ะฝะฐ ะฟะพััั 3456..."
    PORT=3456 npm run dev:https > /tmp/server.log 2>&1 &
    SERVER_PID=$!
    echo "โ ะกะตัะฒะตั ะทะฐะฟััะตะฝ (PID: $SERVER_PID)"
    echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ..."
    sleep 8
else
    echo "โ ะกะตัะฒะตั ัะถะต ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั 3456"
fi

# ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั ัะตัะฒะตัะฐ
if curl -k -s -o /dev/null -w "%{http_code}" https://localhost:3456 | grep -q "200"; then
    echo "โ ะกะตัะฒะตั ะพัะฒะตัะฐะตั"
else
    echo "โ ะกะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั, ะฟัะพะฒะตัััะต ะปะพะณะธ ะฒ /tmp/server.log"
    exit 1
fi

echo ""
echo "๐ ะะฐะฟััะบ Cloudflare Tunnel..."
echo ""

# ะะฐะฟััะบะฐะตะผ cloudflared ะธ ะฟะตัะตัะฒะฐััะฒะฐะตะผ URL
cloudflared tunnel --url https://localhost:3456 2>&1 | while IFS= read -r line; do
    echo "$line"
    # ะัะตะผ ัััะพะบั ั URL
    if echo "$line" | grep -qE "https://[a-z0-9-]+\.trycloudflare\.com"; then
        URL=$(echo "$line" | grep -oE "https://[a-z0-9-]+\.trycloudflare\.com")
        echo ""
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "โ ะขะฃะะะะะฌ ะกะะะะะ!"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""
        echo "๐ ะัะฑะปะธัะฝัะน URL: $URL"
        echo ""
        echo "๐ฑ ะัะบัะพะนัะต ััะพั URL ะฝะฐ ัะตะปะตัะพะฝะต ะฒ ะปัะฑะพะผ ะฑัะฐัะทะตัะต!"
        echo "   (ะะฐะฑะพัะฐะตั ั ะปัะฑะพะณะพ ััััะพะนััะฒะฐ, ะดะฐะถะต ะฝะต ะฒ ะฒะฐัะตะน ัะตัะธ)"
        echo ""
        echo "๐ป ะะพะบะฐะปัะฝัะน ะดะพัััะฟ: https://localhost:3456"
        echo "๐ก ะกะตัั: https://172.16.0.153:3456"
        echo ""
        echo "ะะปั ะพััะฐะฝะพะฒะบะธ ะฝะฐะถะผะธัะต Ctrl+C"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    fi
done

